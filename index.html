<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Portail Quiz ‚Äì Services socles S√©gur &amp; DMP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      background: radial-gradient(circle at top left, #e0f2fe, #fdf2ff 40%, #f5f3ff 70%, #eef2ff 100%);
      color: #0f172a;
      position: relative;
      overflow-x: hidden;
    }
    .bg-bubble {
      position: fixed;
      border-radius: 999px;
      filter: blur(20px);
      opacity: 0.6;
      z-index: -1;
    }
    .b1 { width: 220px; height: 220px; background:#a5b4fc; top:-60px; left:-40px; }
    .b2 { width: 260px; height: 260px; background:#f9a8d4; top:40%; right:-80px; }
    .b3 { width: 180px; height: 180px; background:#6ee7b7; bottom:-60px; left:20%; }

    .container {
      max-width: 1100px;
      width: 100%;
      padding: 1.3rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.9rem;
      flex-wrap:wrap;
    }
    .title-block {
      display:flex;
      align-items:center;
      gap:0.6rem;
      flex-wrap:wrap;
    }
    .main-logo {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background:#22c55e1a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.7rem;
    }
    h1 {
      margin: 0;
      font-size: 1.7rem;
    }
    .subtitle {
      margin:0;
      font-size:0.9rem;
      color:#4b5563;
    }

    .sesan-logo {
      max-height: 40px;
      width:auto;
      object-fit:contain;
    }

    .chips-row {
      display:flex;
      flex-wrap:wrap;
      gap:0.4rem;
      margin-top:0.3rem;
    }
    .chip {
      font-size:0.8rem;
      padding:0.2rem 0.65rem;
      border-radius:999px;
      border:1px dashed #cbd5f5;
      background:rgba(255,255,255,0.6);
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
      color:#4b5563;
    }

    .stage {
      background: rgba(255,255,255,0.96);
      border-radius: 1.4rem;
      padding: 1.1rem 1.3rem;
      box-shadow:
        0 24px 50px rgba(15,23,42,0.12),
        0 0 0 1px rgba(148,163,184,0.2);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 60vh;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    .stage::before {
      content:"";
      position:absolute;
      width:140px;
      height:140px;
      border-radius:999px;
      background:radial-gradient(circle,#e0f2fe,transparent 60%);
      top:-40px;
      right:-40px;
      opacity:0.7;
      pointer-events:none;
    }

    .hidden { display:none !important; }

    .stage-header {
      display:flex;
      justify-content:space-between;
      gap:0.6rem;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:0.6rem;
    }
    .stage-title {
      font-size:1.1rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:0.4rem;
    }
    .stage-sub {
      font-size:0.85rem;
      color:#6b7280;
    }

    .btn {
      border:none;
      border-radius:999px;
      padding:0.6rem 1.5rem;
      font-weight:600;
      cursor:pointer;
      font-size:0.95rem;
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
      transition:transform 0.08s ease, box-shadow 0.1s ease,
        background 0.15s ease, opacity 0.08s ease;
      white-space:nowrap;
    }
    .btn-primary {
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#f9fafb;
      box-shadow:0 12px 25px rgba(34,197,94,0.35);
    }
    .btn-primary:hover {
      transform:translateY(-1px);
      box-shadow:0 18px 30px rgba(34,197,94,0.5);
    }
    .btn-secondary {
      background:#eef2ff;
      color:#4f46e5;
      border:1px solid #c7d2fe;
    }
    .btn-secondary:hover {
      background:#e0e7ff;
      transform:translateY(-1px);
    }
    .btn-ghost {
      background:transparent;
      color:#6b7280;
      border:1px solid #d1d5db;
    }
    .btn-ghost:hover {
      background:#f3f4f6;
    }
    .btn-sm {
      padding:0.3rem 0.8rem;
      font-size:0.8rem;
    }
    .btn[disabled] {
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .home-grid {
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap:1.2rem;
      align-items:center;
      height:100%;
    }
    @media (max-width: 860px) {
      .home-grid {
        grid-template-columns:minmax(0,1fr);
      }
    }

    .home-intro p {
      margin:0.3rem 0;
      font-size:0.95rem;
      color:#374151;
    }
    .home-actions {
      display:flex;
      flex-wrap:wrap;
      gap:0.7rem;
      margin-top:0.9rem;
    }
    .home-note {
      font-size:0.8rem;
      color:#6b7280;
      margin-top:0.5rem;
    }

    .home-logos {
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:0.6rem;
      justify-items:center;
    }
    .home-logos img {
      max-height:60px;
      max-width:100%;
      object-fit:contain;
      filter: drop-shadow(0 4px 8px rgba(148,163,184,0.6));
      background:white;
      border-radius:0.8rem;
      padding:0.25rem 0.4rem;
    }

    .back-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.6rem;
      flex-wrap:wrap;
      margin-bottom:0.6rem;
    }
    .crumb {
      font-size:0.85rem;
      color:#6b7280;
    }

    .service-grid {
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:0.7rem;
    }
    @media(max-width:900px){
      .service-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media(max-width:640px){
      .service-grid { grid-template-columns: minmax(0,1fr); }
    }
    .service-card {
      border-radius:1rem;
      padding:0.8rem 0.9rem;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
      cursor:pointer;
      transition:transform 0.08s ease, box-shadow 0.1s ease, border-color 0.1s ease, background 0.1s ease;
    }
    .service-card:hover {
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(148,163,184,0.55);
      border-color:#c7d2fe;
      background:#eef2ff;
    }
    .service-main {
      display:flex;
      gap:0.6rem;
      align-items:center;
    }
    .service-logo-wrap {
      width:52px;
      height:52px;
      border-radius:0.9rem;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      box-shadow:0 7px 16px rgba(148,163,184,0.6);
      flex-shrink:0;
    }
    .service-logo-wrap img {
      max-width:90%;
      max-height:90%;
      object-fit:contain;
    }
    .service-title {
      font-size:0.95rem;
      font-weight:600;
    }
    .service-tagline {
      font-size:0.8rem;
      color:#6b7280;
    }
    .service-chip {
      font-size:0.78rem;
      align-self:flex-start;
      padding:0.15rem 0.6rem;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }

    .progress-bar {
      width:100%;
      height:0.45rem;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      margin-bottom:0.5rem;
    }
    .progress-fill {
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#3b82f6);
      transition:width 0.25s ease;
    }

    .quiz-meta {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:0.4rem;
      font-size:0.83rem;
      color:#6b7280;
      margin-bottom:0.6rem;
    }
    .quiz-badges {
      display:flex;
      flex-wrap:wrap;
      gap:0.3rem;
      align-items:center;
    }
    .badge {
      padding:0.15rem 0.55rem;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      font-size:0.78rem;
      color:#4b5563;
    }
    .badge-strong {
      border-color:#c7d2fe;
      background:#eef2ff;
      color:#4338ca;
    }
    .badge-timer-ending {
      background:#fef3c7;
      border-color:#facc15;
      color:#92400e;
    }
    .badge-timer-done {
      background:#fee2e2;
      border-color:#ef4444;
      color:#991b1b;
    }

    .question-text {
      font-size:1.05rem;
      margin-bottom:0.4rem;
    }
    .question-extra {
      font-size:0.85rem;
      color:#6b7280;
      margin-bottom:0.4rem;
    }

    .answers {
      display:grid;
      gap:0.45rem;
      margin-top:0.3rem;
    }
    .answer-option {
      border-radius:0.9rem;
      padding:0.5rem 0.7rem;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      display:flex;
      gap:0.55rem;
      align-items:center;
      cursor:pointer;
      transition:background 0.1s ease, border-color 0.1s ease, box-shadow 0.1s ease;
      font-size:0.95rem;
    }
    .answer-option:hover {
      background:#eef2ff;
      border-color:#c7d2fe;
      box-shadow:0 4px 10px rgba(148,163,184,0.4);
    }
    .answer-option input {
      accent-color:#4f46e5;
      cursor:pointer;
    }
    .answer-option.selected {
      background:#e0e7ff;
      border-color:#4f46e5;
      box-shadow:0 0 0 1px rgba(79,70,229,0.5);
    }
    .answer-option.correct {
      background:#ecfdf5;
      border-color:#22c55e;
    }
    .answer-option.incorrect {
      background:#fef2f2;
      border-color:#ef4444;
    }
    .answer-option.disabled {
      cursor:default;
      opacity:0.96;
    }

    .quiz-footer {
      margin-top:0.8rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:0.6rem;
    }
    .quiz-feedback {
      font-size:0.9rem;
    }
    .quiz-feedback.good { color:#16a34a; }
    .quiz-feedback.bad { color:#b91c1c; }

    .result-block {
      text-align:center;
      margin-top:1.2rem;
    }
    .result-score {
      font-size:1.4rem;
      margin-bottom:0.3rem;
    }
    .result-badges {
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:0.4rem;
      margin-bottom:0.4rem;
    }
    .result-text {
      font-size:0.9rem;
      color:#4b5563;
      margin:0.2rem 0;
    }
    .result-leader {
      margin-top:1rem;
      display:grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap:1rem;
      text-align:left;
    }
    @media (max-width: 800px) {
      .result-leader {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .leader-row {
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      align-items:center;
      margin-top:0.3rem;
      margin-bottom:0.3rem;
    }
    #leaderName {
      flex:1 1 180px;
      min-width:160px;
      padding:0.4rem 0.6rem;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:0.9rem;
    }
    .result-text.small-note {
      font-size:0.8rem;
      color:#6b7280;
    }
    .leaderboard-table {
      width:100%;
      border-collapse:collapse;
      font-size:0.82rem;
    }
    .leaderboard-table th,
    .leaderboard-table td {
      border:1px solid #e5e7eb;
      padding:0.25rem 0.35rem;
      text-align:left;
    }
    .leaderboard-table th {
      background:#eff6ff;
    }
    .leaderboard-table tr:nth-child(even) {
      background:#f9fafb;
    }

    .fact-layout {
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,0.8fr);
      gap:1.1rem;
      align-items:center;
      margin-top:0.2rem;
    }
    @media(max-width:820px){
      .fact-layout { grid-template-columns:minmax(0,1fr); }
    }
    .fact-title {
      font-size:1.15rem;
      margin-bottom:0.3rem;
      display:flex;
      align-items:center;
      gap:0.35rem;
    }
    .fact-body {
      font-size:0.94rem;
      color:#374151;
    }
    .fact-tags {
      margin-top:0.35rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.25rem;
    }
    .fact-tag {
      font-size:0.78rem;
      padding:0.15rem 0.6rem;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      color:#4338ca;
    }
    .fact-illu {
      text-align:center;
    }
    .fact-illu-circle {
      width:190px;
      height:190px;
      border-radius:999px;
      margin:0 auto 0.6rem;
      background:radial-gradient(circle at 30% 30%, #bbf7d0, #a5b4fc);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 20px 40px rgba(148,163,184,0.55);
      font-size:3rem;
    }
    .fact-illu-caption {
      font-size:0.86rem;
      color:#6b7280;
    }
    .fact-nav {
      margin-top:0.8rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.6rem;
      flex-wrap:wrap;
      font-size:0.85rem;
      color:#6b7280;
    }
    .dots {
      display:flex;
      gap:0.25rem;
      align-items:center;
    }
    .dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .dot.active {
      width:11px;
      background:#22c55e;
    }

    @media(max-width:640px){
      .stage {
        padding:1rem;
        min-height:auto;
      }
      h1 { font-size:1.45rem; }
    }
  </style>
</head>
<body>
  <div class="bg-bubble b1"></div>
  <div class="bg-bubble b2"></div>
  <div class="bg-bubble b3"></div>

  <div class="container">
    <header>
      <div>
        <div class="title-block">
          <div class="main-logo">üéØ</div>
          <div>
            <h1>Portail quiz ‚Äì Services socles S√©gur</h1>
            <p class="subtitle">DMP, Mon espace sant√©, MSSant√©, INS ‚Äì Animation ludique pour professionnels de sant√©</p>
          </div>
        </div>
        <div class="chips-row">
          <span class="chip">üë©‚Äç‚öïÔ∏èüë®‚Äç‚öïÔ∏è Public : professionnels de sant√©</span>
          <span class="chip">üì± Utilisable sur smartphone</span>
          <span class="chip">üè¢ Animation propos√©e par Sesan</span>
        </div>
      </div>
      <div>
        <img src="Logo Sesan.png" alt="Sesan" class="sesan-logo" />
      </div>
    </header>

    <main class="stage">
      <!-- ACCUEIL -->
      <section id="view-home">
        <div class="home-grid">
          <div class="home-intro">
            <div class="stage-title">
              <span>Bienvenue sur le portail S√©gur &amp; services socles</span>
            </div>
            <p>
              Au programme : un <strong>quiz</strong> pour tester vos connaissances
              et un mode <strong>‚ÄúLe saviez-vous ?‚Äù</strong> pour parcourir les notions cl√©s
              sans √™tre √©valu√©¬∑e.
            </p>
            <p>
              Les questions couvrent les 4 services socles :
              <strong>DMP</strong> (alimentation &amp; consultation),
              <strong>Mon espace sant√©</strong>,
              <strong>Messagerie S√©curis√©e de Sant√©</strong> et
              <strong>Identit√© Nationale de Sant√©</strong>.
            </p>
            <div class="home-actions">
              <button class="btn btn-primary" id="btnGoQuiz">
                üéÆ Je teste mes connaissances
              </button>
              <button class="btn btn-secondary" id="btnGoFacts">
                üí° Je d√©couvre ‚Äì Le saviez-vous ?
              </button>
            </div>
            <p class="home-note">
              Astuce : vous pouvez jouer en solo sur smartphone‚Ä¶ ou lancer un petit d√©fi entre services.
            </p>
          </div>
          <div>
            <div class="home-logos">
              <img src="Logo DMP.png" alt="Dossier M√©dical Partag√©" />
              <img src="logo Mon espace sant√©.jpg" alt="Mon Espace Sant√©" />
              <img src="Logo MSSant√©.png" alt="Messagerie S√©curis√©e de Sant√©" />
              <img src="Logo Identit√© Nationale de Sant√©.png" alt="Identit√© Nationale de Sant√©" />
            </div>
          </div>
        </div>
      </section>

      <!-- CHOIX DU SERVICE SOCLE -->
      <section id="view-quiz-select" class="hidden">
        <div class="back-row">
          <button class="btn btn-ghost" id="btnBackFromQuizSelect">‚¨ÖÔ∏è Retour</button>
          <span class="crumb">√âtape 1/2 ‚Äì Choix du p√©rim√®tre du quiz</span>
        </div>
        <div class="stage-header">
          <div>
            <div class="stage-title">Choisissez votre terrain de jeu</div>
            <div class="stage-sub">Vous pouvez jouer sur l‚Äôensemble des services socles ou vous concentrer sur un seul.</div>
          </div>
        </div>

        <div class="service-grid">
          <article class="service-card" data-service="ALL">
            <div class="service-main">
              <div class="service-logo-wrap">
                <span style="font-size:1.8rem;">üé≤</span>
              </div>
              <div>
                <div class="service-title">Mix de tous les services socles</div>
                <div class="service-tagline">Questions m√©lang√©es DMP, MES, MSSant√©, INS.</div>
              </div>
            </div>
            <div class="service-chip">Mode recommand√© pour un d√©fi complet</div>
          </article>

          <article class="service-card" data-service="DMP">
            <div class="service-main">
              <div class="service-logo-wrap">
                <img src="Logo DMP.png" alt="DMP" />
              </div>
              <div>
                <div class="service-title">Service socle 1 ‚Äì DMP</div>
                <div class="service-tagline">Alimentation &amp; consultation du dossier m√©dical partag√©.</div>
              </div>
            </div>
            <div class="service-chip">üìÇ Donn√©es de sant√© partag√©es</div>
          </article>

          <article class="service-card" data-service="MES">
            <div class="service-main">
              <div class="service-logo-wrap">
                <img src="logo Mon espace sant√©.jpg" alt="Mon Espace Sant√©" />
              </div>
              <div>
                <div class="service-title">Service socle 2 ‚Äì Mon espace sant√©</div>
                <div class="service-tagline">Compte usager, h√©bergement et acc√®s aux donn√©es.</div>
              </div>
            </div>
            <div class="service-chip">üè† Espace num√©rique du citoyen</div>
          </article>

          <article class="service-card" data-service="MSS">
            <div class="service-main">
              <div class="service-logo-wrap">
                <img src="Logo MSSant√©.png" alt="MSSant√©" />
              </div>
              <div>
                <div class="service-title">Service socle 3 ‚Äì MSSant√©</div>
                <div class="service-tagline">Messagerie s√©curis√©e de Sant√© des professionnels.</div>
              </div>
            </div>
            <div class="service-chip">‚úâÔ∏è √âchanges s√©curis√©s</div>
          </article>

          <article class="service-card" data-service="INS">
            <div class="service-main">
              <div class="service-logo-wrap">
                <img src="Logo Identit√© Nationale de Sant√©.png" alt="INS" />
              </div>
              <div>
                <div class="service-title">Service socle 4 ‚Äì INS</div>
                <div class="service-tagline">Identit√© Nationale de Sant√© et traits d‚Äôidentification.</div>
              </div>
            </div>
            <div class="service-chip">üÜî Bien identifi√©¬∑e, bien soign√©¬∑e</div>
          </article>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="view-quiz" class="hidden">
        <div class="back-row">
          <button class="btn btn-ghost" id="btnBackToQuizSelect">‚¨ÖÔ∏è Changer de p√©rim√®tre</button>
          <span class="crumb" id="quizBreadcrumb"></span>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="quizProgress"></div>
        </div>

        <div class="quiz-meta">
          <div id="quizMetaLeft"></div>
          <div class="quiz-badges">
            <span class="badge" id="quizTimerBadge">‚è± Temps restant : 03:00</span>
            <span class="badge"><span>‚úÖ</span><span id="quizScoreBadge">0 bonne r√©ponse</span></span>
            <span class="badge badge-strong"><span>üìä</span><span id="quizQuestionIndex">Question 1 / 1</span></span>
          </div>
        </div>

        <div id="quizQuestionBlock">
          <div class="question-text" id="quizQuestionText"></div>
          <div class="question-extra" id="quizQuestionExtra"></div>
          <div class="answers" id="quizAnswers"></div>
        </div>

        <div class="quiz-footer">
          <div>
            <div id="quizFeedback" class="quiz-feedback"></div>
            <div id="quizExplanation" class="question-extra"></div>
          </div>
          <div style="display:flex; gap:0.6rem; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="btnQuizValidate">‚úÖ Valider</button>
            <button class="btn btn-primary hidden" id="btnQuizNext">‚û°Ô∏è Question suivante</button>
            <button class="btn btn-primary hidden" id="btnQuizSeeResults">üèÅ Voir le bilan</button>
          </div>
        </div>
      </section>

      <!-- R√âSULTATS -->
      <section id="view-quiz-result" class="hidden">
        <div class="back-row">
          <button class="btn btn-ghost" id="btnBackToQuizModes">‚¨ÖÔ∏è Rejouer avec un autre p√©rim√®tre</button>
          <span class="crumb">R√©sum√© de votre session de quiz</span>
        </div>

        <div class="result-block">
          <div class="result-score" id="resultScore"></div>
          <div class="result-badges" id="resultBadges"></div>
          <p class="result-text" id="resultMessage"></p>
          <p class="result-text">
            Pour aller plus loin, vous pouvez relancer un quiz sur un autre service socle
            ou passer en mode <strong>‚ÄúLe saviez-vous ?‚Äù</strong> pour revoir les notions cl√©s.
          </p>
          <div style="margin-top:0.8rem; display:flex; justify-content:center; gap:0.6rem; flex-wrap:wrap;">
            <button class="btn btn-primary" id="btnReplaySame">
              üîÅ Rejouer sur le m√™me p√©rim√®tre
            </button>
            <button class="btn btn-secondary" id="btnGoFactsFromResult">
              üí° Passer en mode ‚ÄúLe saviez-vous ?‚Äù
            </button>
            <button class="btn btn-secondary" id="btnSendResultEmail">
              üìß Envoyer mon score par mail
            </button>
          </div>
        </div>

        <div class="result-leader">
          <div>
            <p class="result-text"><strong>Enregistrer votre score pour le classement (sur cet appareil) :</strong></p>
            <div class="leader-row">
              <input type="text" id="leaderName" placeholder="Votre nom ou nom d‚Äô√©quipe">
              <button class="btn btn-secondary btn-sm" id="btnSaveScore">üíæ Enregistrer mon score</button>
              <button class="btn btn-ghost btn-sm" id="btnClearScores">üßπ Vider le classement</button>
            </div>
            <p class="result-text small-note">
              Les scores sont enregistr√©s localement dans ce navigateur uniquement
              (utile pour projeter un classement en fin de session).
            </p>
          </div>
          <div>
            <p class="result-text"><strong>Classement des participants :</strong></p>
            <table class="leaderboard-table">
              <thead>
                <tr>
                  <th>Rang</th>
                  <th>Nom / √©quipe</th>
                  <th>Score</th>
                  <th>%</th>
                  <th>P√©rim√®tre</th>
                </tr>
              </thead>
              <tbody id="leaderboardBody"></tbody>
            </table>
            <p class="result-text small-note" id="leaderboardEmpty">
              Aucun score enregistr√© pour le moment.
            </p>
          </div>
        </div>
      </section>

      <!-- LE SAVIEZ-VOUS -->
      <section id="view-facts" class="hidden">
        <div class="back-row">
          <button class="btn btn-ghost" id="btnBackFromFacts">‚¨ÖÔ∏è Retour</button>
          <span class="crumb" id="factsIndexLabel">Carte 1 / 4</span>
        </div>

        <div class="stage-header">
          <div>
            <div class="stage-title">Le saviez-vous ? ‚Äì Services socles en bref</div>
            <div class="stage-sub">Faites d√©filer les cartes pour revoir les messages cl√©s sans √™tre √©valu√©¬∑e.</div>
          </div>
        </div>

        <div class="fact-layout">
          <div>
            <div class="fact-title">
              <span id="factsEmoji">üìä</span>
              <span id="factsTitle">DMP &amp; alimentation</span>
            </div>
            <div class="fact-body" id="factsBody"></div>
            <div class="fact-tags" id="factsTags"></div>
          </div>
          <div class="fact-illu">
            <div class="fact-illu-circle" id="factsIllu">üìÇ</div>
            <div class="fact-illu-caption" id="factsCaption"></div>
          </div>
        </div>

        <div class="fact-nav">
          <div class="dots" id="factsDots"></div>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="btnFactsPrev">‚¨ÖÔ∏è Pr√©c√©dent</button>
            <button class="btn btn-primary" id="btnFactsNext">Suivant ‚û°Ô∏è</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Adresse mail de l'organisateur (facultatif).
    // Si vous laissez une cha√Æne vide, le participant devra saisir l'adresse.
    const ORGANIZER_EMAIL = "";

    const LEADERBOARD_KEY = "segurQuizLeaderboard_v1";

    const SERVICES = {
      DMP: { label: "Service socle 1 ‚Äì DMP", icon: "üìÇ" },
      MES: { label: "Service socle 2 ‚Äì Mon espace sant√©", icon: "üè†" },
      MSS: { label: "Service socle 3 ‚Äì MSSant√©", icon: "‚úâÔ∏è" },
      INS: { label: "Service socle 4 ‚Äì Identit√© Nationale de Sant√©", icon: "üÜî" }
    };

    const QUESTIONS = [
  {
    "id": "DMP_A_Q1",
    "service": "DMP",
    "sub": "Alimentation du DMP",
    "text": "Qui peut alimenter le DMP ?",
    "extra": "",
    "options": [
      "Le m√©decin traitant",
      "L‚Äôusager",
      "Les acteurs du m√©dico-social",
      "Tous les acteurs de la Sant√©"
    ],
    "correct": [
      0,
      1,
      2,
      3
    ],
    "explanation": "Tous les acteurs de la sant√© (m√©decine de ville, √©tablissements sanitaires, laboratoires, m√©dico-social‚Ä¶), ainsi que l‚Äôusager lui-m√™me, peuvent alimenter le DMP."
  },
  {
    "id": "DMP_A_Q2",
    "service": "DMP",
    "sub": "Alimentation du DMP",
    "text": "L‚Äôalimentation du DMP est-elle obligatoire ?",
    "extra": "",
    "options": [
      "Non",
      "Oui"
    ],
    "correct": [
      1
    ],
    "explanation": "Oui, l‚Äôalimentation du DMP est obligatoire : c‚Äôest inscrit dans la loi."
  },
  {
    "id": "DMP_C_Q1",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Combien y a-t-il eu de documents consult√©s √† l‚Äôh√¥pital sur le mois de septembre 2025 ?",
    "extra": "",
    "options": [
      "38 698",
      "1 504",
      "12 057"
    ],
    "correct": [
      0
    ],
    "explanation": "En septembre 2025, 38 698 documents ont √©t√© consult√©s √† l‚Äôh√¥pital, ce qui illustre l‚Äôimportance op√©rationnelle du DMP."
  },
  {
    "id": "DMP_C_Q2",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Pour consulter le DMP d‚Äôun patient, le professionnel de sant√© doit-il recueillir son consentement explicite ?",
    "extra": "",
    "options": [
      "Oui",
      "Non",
      "Cela d√©pend du professionnel de sant√©",
      "Cela d√©pend de la prise en charge"
    ],
    "correct": [
      0,
      1,
      2,
      3
    ],
    "explanation": "Au sens de la loi : le consentement est pr√©sum√© pour un professionnel faisant partie de l‚Äô√©quipe de soins et explicite pour un professionnel qui n‚Äôen fait pas partie. Au sens du S√©gur, on encourage un consentement explicite trac√© dans les syst√®mes. En cas de risque vital, le bris de glace est possible avec motif renseign√©."
  },
  {
    "id": "DMP_C_Q3",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Comment se d√©finit un √©pisode de soins ?",
    "extra": "",
    "options": [
      "√Ä travers la r√©glementation",
      "Cela d√©pend de la prise en charge",
      "Cela ne peut pas se d√©finir",
      "C‚Äôest au patient de le d√©finir"
    ],
    "correct": [
      1
    ],
    "explanation": "Il n‚Äôexiste pas de d√©finition r√©glementaire unique de l‚Äô√©pisode de soins. Il correspond √† une p√©riode avec date de d√©but et de fin, en lien avec une pathologie n√©cessitant un suivi ; c‚Äôest √† l‚Äô√©tablissement d‚Äôen d√©finir les contours, ce qui conditionne la dur√©e d‚Äôautorisation de consultation."
  },
  {
    "id": "DMP_C_Q4",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Comment est trac√©e la consultation d‚Äôun DMP dans Mon Espace Sant√© ?",
    "extra": "",
    "options": [
      "Elle n‚Äôest pas trac√©e",
      "Un mail est transmis au patient concern√©",
      "Une notification appara√Æt dans le profil MES du patient",
      "Un SMS est transmis par l‚Äô√©tablissement qui consulte"
    ],
    "correct": [
      1,
      2
    ],
    "explanation": "La consultation est trac√©e : le patient peut √™tre averti par mail s‚Äôil n‚Äôa pas l‚Äôapplication MES, ou par notification dans l‚Äôapplication. Il retrouve l‚Äôhistorique des acc√®s et l‚Äôidentit√© des professionnels."
  },
  {
    "id": "DMP_C_Q5",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Pour consulter le DMP d‚Äôun mineur, faut-il recueillir le consentement des deux parents ?",
    "extra": "",
    "options": [
      "Oui",
      "Non"
    ],
    "correct": [
      1
    ],
    "explanation": "Non. Il n‚Äôexiste pas de r√©gime sp√©cifique encadrant la consultation du DMP pour les mineurs : on applique la m√™me logique que pour le consentement aux soins."
  },
  {
    "id": "DMP_C_Q6",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Dans le cadre de majeurs sous tutelle (repr√©sentation de biens), qui peut donner le consentement √† la consultation de son DMP ?",
    "extra": "",
    "options": [
      "Le majeur lui-m√™me",
      "Le tuteur",
      "Le juge"
    ],
    "correct": [
      0
    ],
    "explanation": "Dans ce cas, c‚Äôest le majeur lui-m√™me qui donne son consentement √† la consultation de son DMP."
  },
  {
    "id": "DMP_C_Q7",
    "service": "DMP",
    "sub": "Consultation du DMP",
    "text": "Que signifie la connexion secr√®te ?",
    "extra": "",
    "options": [
      "Le patient consulte son DMP sans que les PS soient notifi√©s",
      "Le PS consulte le DMP sans aucune trace pour le patient",
      "Le PS active la connexion secr√®te sur demande du patient mineur",
      "Le PS consulte sans que les repr√©sentants l√©gaux soient notifi√©s de la consultation"
    ],
    "correct": [
      2,
      3
    ],
    "explanation": "La connexion secr√®te permet au professionnel de sant√©, √† la demande du patient mineur, de consulter le DMP sans notifier automatiquement les repr√©sentants l√©gaux, tout en conservant une tra√ßabilit√©."
  },
  {
    "id": "MES_Q1",
    "service": "MES",
    "sub": "Mon espace sant√©",
    "text": "Comment un usager peut-il demander l‚Äôouverture de son compte Mon espace sant√© ?",
    "extra": "",
    "options": [
      "En demandant √† son m√©decin traitant",
      "Pas la peine, il est d√©j√† ouvert !",
      "En appelant le 3422, ils s‚Äôoccupent de tout"
    ],
    "correct": [
      1,
      2
    ],
    "explanation": "Les comptes MES ont √©t√© cr√©√©s pour la plupart des assur√©s. L‚Äôusager doit surtout activer son compte. En cas de besoin, le 3422 peut l‚Äôaccompagner."
  },
  {
    "id": "MES_Q2",
    "service": "MES",
    "sub": "Mon espace sant√©",
    "text": "O√π sont stock√©es les donn√©es de Mon espace sant√© ?",
    "extra": "",
    "options": [
      "Chez Microsoft, dans le cadre de ses missions philanthropiques",
      "Dans un endroit tenu secret",
      "Dans l‚Äôordinateur ou le smartphone de l‚Äôusager",
      "En France, chez un h√©bergeur agr√©√© HDS"
    ],
    "correct": [
      3
    ],
    "explanation": "Les donn√©es MES sont h√©berg√©es en France chez un H√©bergeur de Donn√©es de Sant√© (HDS) agr√©√©."
  },
  {
    "id": "MSS_Q1",
    "service": "MSS",
    "sub": "MSSant√©",
    "text": "Comment un professionnel de sant√© inscrit √† l‚Äôordre peut-il ouvrir sa Messagerie S√©curis√©e de Sant√© ?",
    "extra": "",
    "options": [
      "En la demandant √† un op√©rateur comme Gmail ou Microsoft",
      "Elle est automatiquement cr√©√©e d√®s son inscription √† l‚Äôordre"
    ],
    "correct": [
      1
    ],
    "explanation": "D√®s son inscription √† l‚Äôordre, une adresse MSSant√© est cr√©√©e pour le professionnel et r√©f√©renc√©e dans l‚Äôannuaire sant√©."
  },
  {
    "id": "MSS_Q2",
    "service": "MSS",
    "sub": "MSSant√©",
    "text": "Comment retrouver une adresse MSSant√© ?",
    "extra": "",
    "options": [
      "En recherchant sur Google",
      "En consultant l‚Äôannuaire sant√©"
    ],
    "correct": [
      1
    ],
    "explanation": "Les adresses MSSant√© sont r√©f√©renc√©es dans l‚Äôannuaire sant√©, accessible √† tous."
  },
  {
    "id": "INS_Q1",
    "service": "INS",
    "sub": "Identit√© Nationale de Sant√©",
    "text": "De quels traits d‚Äôidentit√© est compos√©e une INS ?",
    "extra": "",
    "options": [
      "Du num√©ro de s√©curit√© sociale uniquement",
      "Nom de naissance, pr√©nom de naissance, date de naissance, genre",
      "Nom de naissance, pr√©nom de naissance, date de naissance, genre, code commune de naissance",
      "Nom de naissance, pr√©nom de naissance, date de naissance, genre, code commune de naissance, code commune d‚Äôhabitation"
    ],
    "correct": [
      2
    ],
    "explanation": "Une INS repose notamment sur les traits : nom et pr√©nom(s) de naissance, date de naissance, genre et code commune de naissance."
  },
  {
    "id": "INS_Q2",
    "service": "INS",
    "sub": "Identit√© Nationale de Sant√©",
    "text": "Un mineur a-t-il une INS ?",
    "extra": "",
    "options": [
      "Non, car il n‚Äôa pas encore de num√©ro de s√©curit√© sociale",
      "Oui"
    ],
    "correct": [
      1
    ],
    "explanation": "Oui : d√®s la naissance, une personne physique dispose d‚Äôune INS."
  },
  {
    "id": "MSS_Q3",
    "service": "MSS",
    "sub": "",
    "text": "Est-ce  qu'un usager dispose t-il d'une adresse MSSant√© ?",
    "extra": "",
    "options": [
      "Non, seuls les professionnels de sant√© disposent d'une MSSant√© ?",
      "Oui, c'est possible, il faut demander une cr√©ation de MSSant√© √† l'Assurance Maladie",
      "Oui, elle est incluse dans Mon espace sant√©"
    ],
    "correct": [
      2
    ],
    "explanation": ""
  },
  {
    "id": "MSS_Q4",
    "service": "MSS",
    "sub": "",
    "text": "Dans quel cas un usager peut √©crire directement √† un Professionnel de Sant√© via la MSSant√© ?",
    "extra": "",
    "options": [
      "Seulement si le Professionnel de Sant√© a initi√© un √©change via MSSant√©",
      "Si le professionnel de sant√© donne son consentement dans le DMP",
      "Si l'usager veut envoyer une ordonnance √† un pharmacien",
      "Si le professionnel de sant√© est injoignable par t√©l√©phone"
    ],
    "correct": [
      0,
      2
    ],
    "explanation": ""
  },
  {
    "id": "MSS_Q5",
    "service": "MSS",
    "sub": "",
    "text": "J'ai plusieurs contextes d'exercice professionnels dois-je avoir plusieurs boites MSSant√© ?",
    "extra": "",
    "options": [
      "Oui,",
      "Non, je peux cr√©er des alias"
    ],
    "correct": [
      0
    ],
    "explanation": "Pour chaque contexte d'exercice vous devez disposer d'une adresse MSSant√© d√©di√©e soit nominative soit organisationnelle."
  },
  {
    "id": "INS_Q3",
    "service": "INS",
    "sub": "",
    "text": "Quelle pi√®ce justificative permet de qualifier une Identit√© Nationale de Sant√© (INS) ?",
    "extra": "",
    "options": [
      "Une Carte Nationale d‚ÄôIdentit√©",
      "Un permis de conduire",
      "Une Carte Vitale",
      "Un titre de s√©jour de moins de 10 ans",
      "Un livret de famille"
    ],
    "correct": [
      0,
      4
    ],
    "explanation": ""
  }
];


    const FACTS = [
      {
        emoji: "üìÇ",
        title: "DMP ‚Äì alimentation & consultation",
        body: "Tous les acteurs de la sant√©, ainsi que l‚Äôusager, peuvent alimenter le DMP. Son usage est <strong>obligatoire</strong> et a d√©j√† un impact fort : en septembre 2025, plus de <strong>38 000 documents</strong> ont √©t√© consult√©s √† l‚Äôh√¥pital.",
        tags: ["DMP", "Alimentation", "Usage r√©el"],
        illu: "üìä",
        caption: "Un outil de partage de donn√©es d√©j√† fortement utilis√©."
      },
      {
        emoji: "üîê",
        title: "Consentement, bris de glace & connexion secr√®te",
        body: "Le consentement est <strong>pr√©sum√©</strong> pour l‚Äô√©quipe de soins et <strong>explicite</strong> pour les autres professionnels. En cas de risque vital, le <strong>bris de glace</strong> permet un acc√®s trac√© avec motif. Pour certains soins de mineurs, la <strong>connexion secr√®te</strong> permet de ne pas notifier automatiquement les repr√©sentants l√©gaux.",
        tags: ["Consentement", "Bris de glace", "Connexion secr√®te"],
        illu: "üß©",
        caption: "Des m√©canismes pour concilier qualit√© des soins, droits et confidentialit√©."
      },
      {
        emoji: "üè†",
        title: "Mon espace sant√© & MSSant√©",
        body: "Les comptes <strong>Mon espace sant√©</strong> ont √©t√© cr√©√©s pour la plupart des assur√©s et sont h√©berg√©s en France chez un <strong>H√©bergeur de Donn√©es de Sant√©</strong>. La <strong>Messagerie S√©curis√©e de Sant√©</strong>, elle, est automatiquement cr√©√©e pour les professionnels inscrits √† l‚Äôordre et r√©f√©renc√©e dans l‚Äôannuaire sant√©.",
        tags: ["Mon espace sant√©", "MSSant√©", "H√©bergement HDS"],
        illu: "‚úâÔ∏è",
        caption: "Deux briques compl√©mentaires : espace usager et messagerie professionnelle."
      },
      {
        emoji: "üÜî",
        title: "Identit√© Nationale de Sant√© (INS)",
        body: "L‚Äô<strong>INS</strong> s‚Äôappuie sur des traits d‚Äôidentit√© stables : nom et pr√©nom(s) de naissance, date de naissance, genre et code commune de naissance. Elle concerne <strong>toute personne d√®s la naissance</strong>, mineurs compris.",
        tags: ["INS", "Identification", "Qualit√© des donn√©es"],
        illu: "üìá",
        caption: "Une identit√© fiable, pour √™tre bien identifi√©¬∑e et bien soign√©¬∑e."
      }
    ];

    const viewHome        = document.getElementById("view-home");
    const viewQuizSelect  = document.getElementById("view-quiz-select");
    const viewQuiz        = document.getElementById("view-quiz");
    const viewQuizResult  = document.getElementById("view-quiz-result");
    const viewFacts       = document.getElementById("view-facts");

    function showView(view) {
      [viewHome, viewQuizSelect, viewQuiz, viewQuizResult, viewFacts].forEach(v => v.classList.add("hidden"));
      view.classList.remove("hidden");
    }

    document.getElementById("btnGoQuiz").addEventListener("click", () => {
      showView(viewQuizSelect);
    });
    document.getElementById("btnGoFacts").addEventListener("click", () => {
      showView(viewFacts);
      renderFact(0);
    });
    document.getElementById("btnBackFromQuizSelect").addEventListener("click", () => {
      showView(viewHome);
    });
    document.getElementById("btnBackFromFacts").addEventListener("click", () => {
      showView(viewHome);
    });

    // QUIZ + TIMER + SCORE + CLASSEMENT
    let quizServiceFilter = "ALL";
    let quizActive = [];
    let quizIndex = 0;
    let quizScore = 0;

    let quizTimerSeconds = 0;
    let quizTimerInterval = null;
    let quizTimeUp = false;

    const quizBreadcrumb = document.getElementById("quizBreadcrumb");
    const quizProgress   = document.getElementById("quizProgress");
    const quizMetaLeft   = document.getElementById("quizMetaLeft");
    const quizScoreBadge = document.getElementById("quizScoreBadge");
    const quizQuestionIndex = document.getElementById("quizQuestionIndex");
    const quizTimerBadge = document.getElementById("quizTimerBadge");

    const quizQuestionText  = document.getElementById("quizQuestionText");
    const quizQuestionExtra = document.getElementById("quizQuestionExtra");
    const quizAnswers       = document.getElementById("quizAnswers");

    const quizFeedback     = document.getElementById("quizFeedback");
    const quizExplanation  = document.getElementById("quizExplanation");
    const btnQuizValidate  = document.getElementById("btnQuizValidate");
    const btnQuizNext      = document.getElementById("btnQuizNext");
    const btnQuizSeeResults = document.getElementById("btnQuizSeeResults");
    const btnBackToQuizSelect = document.getElementById("btnBackToQuizSelect");

    btnBackToQuizSelect.addEventListener("click", () => {
      showView(viewQuizSelect);
      stopQuizTimer();
    });

    function shuffle(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function startQuiz(filter) {
      quizServiceFilter = filter;
      quizActive = QUESTIONS.filter(q => filter === "ALL" ? true : q.service === filter);
      quizActive = shuffle(quizActive);
      quizIndex = 0;
      quizScore = 0;
      quizFeedback.textContent = "";
      quizExplanation.textContent = "";
      btnQuizSeeResults.classList.add("hidden");
      btnQuizNext.classList.add("hidden");
      btnQuizValidate.disabled = false;
      quizTimeUp = false;
      resetTimerBadge();
      startQuizTimer(180); // 3 minutes
      showView(viewQuiz);
      renderQuizQuestion();
    }

    function resetTimerBadge() {
      quizTimerBadge.classList.remove("badge-timer-ending", "badge-timer-done");
      quizTimerBadge.textContent = "‚è± Temps restant : 03:00";
    }

    function startQuizTimer(seconds) {
      stopQuizTimer();
      quizTimerSeconds = seconds;
      updateTimerBadge();
      quizTimerInterval = setInterval(() => {
        quizTimerSeconds -= 1;
        if (quizTimerSeconds <= 0) {
          quizTimerSeconds = 0;
          updateTimerBadge();
          stopQuizTimer();
          handleTimeUp();
        } else {
          updateTimerBadge();
        }
      }, 1000);
    }

    function stopQuizTimer() {
      if (quizTimerInterval) {
        clearInterval(quizTimerInterval);
        quizTimerInterval = null;
      }
    }

    function updateTimerBadge() {
      const mm = String(Math.floor(quizTimerSeconds / 60)).padStart(2,"0");
      const ss = String(quizTimerSeconds % 60).padStart(2,"0");
      quizTimerBadge.textContent = "‚è± Temps restant : " + mm + ":" + ss;
      quizTimerBadge.classList.remove("badge-timer-ending", "badge-timer-done");
      if (quizTimerSeconds <= 30 && quizTimerSeconds > 0) {
        quizTimerBadge.classList.add("badge-timer-ending");
      }
      if (quizTimerSeconds === 0) {
        quizTimerBadge.classList.add("badge-timer-done");
        quizTimerBadge.textContent = "‚è± Temps √©coul√©";
      }
    }

    function handleTimeUp() {
      if (quizTimeUp) return;
      quizTimeUp = true;
      // Si on n'est pas d√©j√† sur l'√©cran de r√©sultat, on y va
      if (viewQuizResult.classList.contains("hidden")) {
        alert("‚è∞ Temps √©coul√© ! Nous affichons votre score sur les questions r√©pondues.");
        showQuizResults();
      }
    }

    function renderQuizQuestion() {
      const total = quizActive.length;
      const q = quizActive[quizIndex];
      const service = SERVICES[q.service];

      quizBreadcrumb.textContent = quizServiceFilter === "ALL"
        ? "Quiz ‚Äì Tous services socles"
        : "Quiz ‚Äì " + (service ? service.label : "");

      const pct = (quizIndex / total) * 100;
      quizProgress.style.width = pct + "%";

      quizMetaLeft.textContent =
        (service ? service.icon + " " + service.label : "Mix de services") +
        " ¬∑ Sous-th√®me : " + (q.sub || "G√©n√©ral");

      quizScoreBadge.textContent =
        quizScore + " bonne" + (quizScore > 1 ? "s" : "") +
        " r√©ponse" + (quizScore === 0 ? "" : "s");

      quizQuestionIndex.textContent = "Question " + (quizIndex + 1) + " / " + total;

      quizQuestionText.textContent = q.text;
      quizQuestionExtra.textContent = q.extra || "";
      quizAnswers.innerHTML = "";
      quizFeedback.textContent = "";
      quizExplanation.textContent = "";

      q.options.forEach((opt, idx) => {
        const label = document.createElement("label");
        label.className = "answer-option";
        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = String(idx);
        const span = document.createElement("span");
        span.textContent = opt;
        label.appendChild(input);
        label.appendChild(span);

        label.addEventListener("click", (e) => {
          if (input.disabled) return;
          if (e.target.tagName.toLowerCase() !== "input") {
            input.checked = !input.checked;
          }
          label.classList.toggle("selected", input.checked);
        });

        quizAnswers.appendChild(label);
      });

      btnQuizValidate.classList.remove("hidden");
      btnQuizNext.classList.add("hidden");
      btnQuizSeeResults.classList.add("hidden");
      btnQuizValidate.disabled = false;
    }

    function getSelectedOptionIndexes() {
      const inputs = quizAnswers.querySelectorAll("input[type='checkbox']");
      const selected = [];
      inputs.forEach((input, i) => {
        if (input.checked) selected.push(i);
      });
      return selected;
    }

    function arraysEqualAsSets(a, b) {
      if (a.length !== b.length) return false;
      const sA = new Set(a);
      const sB = new Set(b);
      if (sA.size !== sB.size) return false;
      for (const v of sA) if (!sB.has(v)) return false;
      return true;
    }

    function validateQuizQuestion() {
      if (quizTimeUp) {
        alert("Le temps est √©coul√©. Le quiz est termin√©.");
        return;
      }
      const q = quizActive[quizIndex];
      const selected = getSelectedOptionIndexes();
      if (!selected.length) {
        alert("Merci de s√©lectionner au moins une proposition.");
        return;
      }

      const correctSet = q.correct || [];
      const isCorrect = arraysEqualAsSets(selected, correctSet);
      if (isCorrect) quizScore += 1;

      const options = quizAnswers.querySelectorAll(".answer-option");
      options.forEach((opt, idx) => {
        const input = opt.querySelector("input");
        input.disabled = true;
        opt.classList.add("disabled");
        if (correctSet.includes(idx)) {
          opt.classList.add("correct");
        }
        if (selected.includes(idx) && !correctSet.includes(idx)) {
          opt.classList.add("incorrect");
        }
      });

      quizScoreBadge.textContent =
        quizScore + " bonne" + (quizScore > 1 ? "s" : "") +
        " r√©ponse" + (quizScore === 0 ? "" : "s");

      quizFeedback.textContent = isCorrect
        ? "‚úÖ Bravo, toutes les bonnes r√©ponses ont √©t√© s√©lectionn√©es."
        : "‚ùå R√©ponse partielle ou incorrecte.";
      quizFeedback.className = "quiz-feedback " + (isCorrect ? "good" : "bad");

      quizExplanation.innerHTML = q.explanation || "";

      btnQuizValidate.disabled = true;
      const isLast = quizIndex === quizActive.length - 1;
      if (isLast) {
        btnQuizSeeResults.classList.remove("hidden");
      } else {
        btnQuizNext.classList.remove("hidden");
      }
    }

    function nextQuizQuestion() {
      quizIndex += 1;
      if (quizIndex >= quizActive.length) {
        showQuizResults();
      } else {
        renderQuizQuestion();
      }
    }

    function getPerimeterLabel() {
      if (quizServiceFilter === "ALL") {
        return "Tous les services socles";
      }
      const s = SERVICES[quizServiceFilter];
      return s ? s.label : "Service inconnu";
    }

    function showQuizResults() {
      stopQuizTimer();
      showView(viewQuizResult);

      const total = quizActive.length;
      const pct = total > 0 ? Math.round((quizScore / total) * 100) : 0;

      const resultScore = document.getElementById("resultScore");
      const resultBadges = document.getElementById("resultBadges");
      const resultMessage = document.getElementById("resultMessage");

      resultScore.textContent = "Score : " + quizScore + " / " + total + " (" + pct + " %)";

      let niveau;
      if (pct === 100) niveau = "Expert¬∑e des services socles";
      else if (pct >= 70) niveau = "√Ä l‚Äôaise sur le sujet";
      else if (pct >= 40) niveau = "En bonne voie";
      else niveau = "En d√©couverte ‚Äì l‚Äôessentiel est de participer !";

      resultBadges.innerHTML = "";
      const badge1 = document.createElement("span");
      badge1.className = "badge badge-strong";
      badge1.textContent = niveau;
      resultBadges.appendChild(badge1);

      if (quizServiceFilter === "ALL") {
        const badge2 = document.createElement("span");
        badge2.className = "badge";
        badge2.textContent = "Mix de tous les services socles";
        resultBadges.appendChild(badge2);
      } else {
        const s = SERVICES[quizServiceFilter];
        if (s) {
          const badge2 = document.createElement("span");
          badge2.className = "badge";
          badge2.textContent = s.label;
          resultBadges.appendChild(badge2);
        }
      }

      resultMessage.textContent =
        "Vous pouvez relancer un quiz, changer de service socle ou passer en mode ‚ÄúLe saviez-vous ?‚Äù pour revoir les notions cl√©s de fa√ßon plus tranquille.";

      // Met √† jour l'affichage du classement
      renderLeaderboard();
    }

    btnQuizValidate.addEventListener("click", validateQuizQuestion);
    btnQuizNext.addEventListener("click", nextQuizQuestion);
    btnQuizSeeResults.addEventListener("click", showQuizResults);

    document.getElementById("btnReplaySame").addEventListener("click", () => {
      startQuiz(quizServiceFilter);
    });
    document.getElementById("btnGoFactsFromResult").addEventListener("click", () => {
      showView(viewFacts);
      renderFact(0);
    });
    document.getElementById("btnBackToQuizModes").addEventListener("click", () => {
      showView(viewQuizSelect);
    });

    document.querySelectorAll(".service-card").forEach(card => {
      card.addEventListener("click", () => {
        const service = card.getAttribute("data-service");
        startQuiz(service || "ALL");
      });
    });

    // LEADERBOARD LOCAL
    function loadLeaderboard() {
      try {
        const raw = localStorage.getItem(LEADERBOARD_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      } catch(e) {
        return [];
      }
    }

    function saveLeaderboard(list) {
      try {
        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(list));
      } catch(e) {
        console.error("Impossible d‚Äôenregistrer le classement :", e);
      }
    }

    function renderLeaderboard() {
      const body = document.getElementById("leaderboardBody");
      const empty = document.getElementById("leaderboardEmpty");
      const data = loadLeaderboard();
      body.innerHTML = "";

      if (!data.length) {
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      data
        .slice()
        .sort((a,b) => b.pct - a.pct || b.score - a.score)
        .forEach((entry, index) => {
          const tr = document.createElement("tr");
          const tdRank = document.createElement("td");
          const tdName = document.createElement("td");
          const tdScore = document.createElement("td");
          const tdPct = document.createElement("td");
          const tdPerim = document.createElement("td");

          tdRank.textContent = index + 1;
          tdName.textContent = entry.name || "‚Äî";
          tdScore.textContent = entry.score + " / " + entry.total;
          tdPct.textContent = entry.pct + " %";
          tdPerim.textContent = entry.perimeter || "";

          tr.appendChild(tdRank);
          tr.appendChild(tdName);
          tr.appendChild(tdScore);
          tr.appendChild(tdPct);
          tr.appendChild(tdPerim);

          body.appendChild(tr);
        });
    }

    const btnSaveScore = document.getElementById("btnSaveScore");
    const btnClearScores = document.getElementById("btnClearScores");
    const leaderNameInput = document.getElementById("leaderName");

    btnSaveScore.addEventListener("click", () => {
      const name = (leaderNameInput.value || "").trim();
      if (!name) {
        alert("Merci de renseigner un nom ou nom d‚Äô√©quipe.");
        return;
      }
      if (!quizActive || !quizActive.length) {
        alert("Aucun quiz n‚Äôa √©t√© jou√© pour l‚Äôinstant.");
        return;
      }
      const total = quizActive.length;
      const pct = total > 0 ? Math.round((quizScore / total) * 100) : 0;
      const perimeter = getPerimeterLabel();

      const list = loadLeaderboard();
      list.push({
        name,
        score: quizScore,
        total,
        pct,
        perimeter,
        timestamp: new Date().toISOString()
      });
      saveLeaderboard(list);
      renderLeaderboard();
      leaderNameInput.value = "";
      alert("Score enregistr√© pour le classement local.");
    });

    btnClearScores.addEventListener("click", () => {
      if (confirm("Supprimer tous les scores enregistr√©s sur cet appareil ?")) {
        saveLeaderboard([]);
        renderLeaderboard();
      }
    });

    // ENVOI DE SCORE PAR MAIL (mailto)
    const btnSendResultEmail = document.getElementById("btnSendResultEmail");
    btnSendResultEmail.addEventListener("click", () => {
      if (!quizActive || !quizActive.length) {
        alert("Merci de jouer au quiz avant d‚Äôenvoyer votre score par mail.");
        return;
      }
      const total = quizActive.length;
      const pct = total > 0 ? Math.round((quizScore / total) * 100) : 0;

      const participantName = prompt("Votre nom / √©quipe (pour le classement) :");
      if (!participantName) return;

      let email = ORGANIZER_EMAIL;
      if (!email) {
        const entered = prompt("Adresse mail de l‚Äôorganisateur (o√π envoyer votre score) :");
        if (!entered) return;
        email = entered.trim();
      }

      const perimetre = getPerimeterLabel();

      const subject = encodeURIComponent("Score Quiz S√©gur ‚Äì " + participantName);

      const bodyLines = [
        "Nom / √©quipe : " + participantName,
        "Score : " + quizScore + " / " + total + " (" + pct + " %)",
        "P√©rim√®tre : " + perimetre,
        "",
        "Envoy√© depuis le quiz S√©gur & services socles.",
        "√âv√©nement : JOURN√âE DES CPTS YVELINOISES 2025 ‚Äì Poissy"
      ];
      const body = encodeURIComponent(bodyLines.join("\n"));

      const mailtoUrl = "mailto:" + encodeURIComponent(email)
        + "?subject=" + subject
        + "&body=" + body;

      window.location.href = mailtoUrl;
    });

    // LE SAVIEZ-VOUS
    let currentFactIndex = 0;
    const factsEmoji   = document.getElementById("factsEmoji");
    const factsTitle   = document.getElementById("factsTitle");
    const factsBody    = document.getElementById("factsBody");
    const factsTags    = document.getElementById("factsTags");
    const factsIllu    = document.getElementById("factsIllu");
    const factsCaption = document.getElementById("factsCaption");
    const factsDots    = document.getElementById("factsDots");
    const factsIndexLabel = document.getElementById("factsIndexLabel");
    const btnFactsPrev = document.getElementById("btnFactsPrev");
    const btnFactsNext = document.getElementById("btnFactsNext");

    function renderFactsDots() {
      factsDots.innerHTML = "";
      FACTS.forEach((_, idx) => {
        const d = document.createElement("div");
        d.className = "dot" + (idx === currentFactIndex ? " active" : "");
        factsDots.appendChild(d);
      });
    }

    function renderFact(idx) {
      const total = FACTS.length;
      currentFactIndex = (idx + total) % total;
      const f = FACTS[currentFactIndex];

      factsIndexLabel.textContent = "Carte " + (currentFactIndex + 1) + " / " + total;
      factsEmoji.textContent = f.emoji || "üí°";
      factsTitle.textContent = f.title || "Le saviez-vous ?";
      factsBody.innerHTML = f.body || "";
      factsIllu.textContent = f.illu || "üí°";
      factsCaption.textContent = f.caption || "";

      factsTags.innerHTML = "";
      if (f.tags && f.tags.length) {
        f.tags.forEach(t => {
          const span = document.createElement("span");
          span.className = "fact-tag";
          span.textContent = t;
          factsTags.appendChild(span);
        });
      }
      renderFactsDots();
    }

    btnFactsPrev.addEventListener("click", () => {
      renderFact(currentFactIndex - 1);
    });
    btnFactsNext.addEventListener("click", () => {
      renderFact(currentFactIndex + 1);
    });

    // Init
    renderFact(0);
    renderLeaderboard();
  </script>
</body>
</html>

